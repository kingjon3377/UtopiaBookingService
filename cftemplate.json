{
  "Description": "Create an EC2 instance by AWS CloudFormation",
  "Parameters": {
    "JarFileSource": {"Type": "String"},
    "JarFileName": {"Type": "String"},
    "IAMRoleName": {"Type": "String"},
    "EC2KeyName": {"Type": "String"},
    "KibanaHostname": {"Type": "String"},
    "ElasticSearchHostname": {"Type": "String"}
  },
  "Resources": {
    "EC2InstanceDemoSvr": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "AvailabilityZone": "us-east-1a",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "8",
              "VolumeType": "gp2"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [ "\n", [
              "#!/bin/bash",
              "yum update -y",
              "yum install -y java-1.8.0-openjdk-headless.x86_64",
              "rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch",
              "cat > /etc/yum.repos.d/elastic.repo <<-EOF",
              "[elastic-6.x]",
              "name=Elastic repository for 6.x packages",
              "baseurl=https://artifacts.elastic.co/packages/oss-6.x/yum",
              "gpgcheck=1",
              "gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch",
              "enabled=1",
              "autorefresh=1",
              "type=rpm-md",
              "EOF",
              "yum install -y filebeat",
	      "mkdir -p /var/log/filebeat",
              "touch /var/log/utopia-booking.log",
              "chown ec2-user /var/log/utopia-booking.log",
              {"Fn::Join": ["", ["sed -i -e 's@#host: \"localhost:5601\"@host: ", {"Ref": "KibanaHostname"},
                      "@' -e 's@hosts: \\[\"localhost:9200\"]@hosts: \\[\"", {"Ref": "ElasticSearchHostname"},
                      ":443\"]@' -e 's@/var/log/\\*.log@/var/log/utopia-booking.log@' /etc/filebeat/filebeat.yml"]]},
              "echo 'xpack.monitoring.enabled: false' >> /etc/filebeat/filebeat.yml",
              "filebeat setup --pipelines --template --dashboards",
              "filebeat test output",
              "service filebeat start",
              {"Fn::Join": [ " ", ["aws s3 cp", {"Ref": "JarFileSource"}, "."]]},
              {"Fn::Join": [ " ", ["nohup java -jar -Dlogging.file=/var/log/utopia-booking.log", {"Ref": "JarFileName"}, "&"]]}
            ]]
          }
        },
        "IamInstanceProfile" : {"Ref": "IAMRoleName"},
        "ImageId": "ami-0c6b1d09930fac512",
        "InstanceType": "t2.micro",
        "KeyName": {"Ref": "EC2KeyName"},
        "SecurityGroups":["launch-wizard-7"]
      }
    }
  },

  "Outputs" : {
    "Ec2EndPoint": {
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceDemoSvr",
          "PublicDnsName"
        ]
      },
      "Description": "public DNS"
    }
  }
}
